# ansible/playbooks/configure-nginx.yml
---
- name: Configure Multi-Cloud Infrastructure
  hosts: all
  become: yes
  gather_facts: yes
  
  tasks:
    - name: Update package cache (Debian/Ubuntu)
      apt:
        update_cache: yes
      when: ansible_os_family == "Debian"
    
    - name: Update package cache (RedHat/Amazon)
      yum:
        update_cache: yes
      when: ansible_os_family == "RedHat"
    
    - name: Install nginx
      package:
        name: nginx
        state: present
    
    - name: Create web directory
      file:
        path: /var/www/cloudguard
        state: directory
        owner: www-data
        group: www-data
        mode: '0755'
      when: ansible_os_family == "Debian"
    
    - name: Create web directory (RedHat)
      file:
        path: /var/www/cloudguard
        state: directory
        owner: nginx
        group: nginx
        mode: '0755'
      when: ansible_os_family == "RedHat"
    
    - name: Deploy web interface
      template:
        src: ../templates/index.html.j2
        dest: /var/www/cloudguard/index.html
        mode: '0644'
    
    - name: Configure nginx site (Debian/Ubuntu)
      copy:
        content: |
          server {
              listen 80 default_server;
              listen [::]:80 default_server;
              server_name _;
              
              root /var/www/cloudguard;
              index index.html;
              
              # Main page
              location / {
                  try_files $uri $uri/ =404;
              }
              
              # Health check endpoint
              location /health {
                  default_type application/json;
                  return 200 '{"status":"healthy","provider":"{{ cloud_provider }}","instance":"{{ ansible_hostname }}","timestamp":"{{ ansible_date_time.iso8601 }}"}';
              }
              
              # Nginx status for Datadog
              location /nginx_status {
                  stub_status on;
                  access_log off;
                  allow 127.0.0.1;
                  allow ::1;
                  deny all;
              }
          }
        dest: /etc/nginx/sites-available/default
        force: yes
      when: ansible_os_family == "Debian"
      notify: restart nginx
    
    - name: Configure nginx site (RedHat/Amazon)
      copy:
        content: |
          server {
              listen 80 default_server;
              listen [::]:80 default_server;
              server_name _;
              
              root /var/www/cloudguard;
              index index.html;
              
              # Main page
              location / {
                  try_files $uri $uri/ =404;
              }
              
              # Health check endpoint
              location /health {
                  default_type application/json;
                  return 200 '{"status":"healthy","provider":"{{ cloud_provider }}","instance":"{{ ansible_hostname }}","timestamp":"{{ ansible_date_time.iso8601 }}"}';
              }
              
              # Nginx status for Datadog
              location /nginx_status {
                  stub_status on;
                  access_log off;
                  allow 127.0.0.1;
                  allow ::1;
                  deny all;
              }
          }
        dest: /etc/nginx/conf.d/default.conf
        force: yes
      when: ansible_os_family == "RedHat"
      notify: restart nginx
    
    - name: Ensure nginx is started and enabled
      systemd:
        name: nginx
        state: started
        enabled: yes
    
    # ===== DATADOG AGENT INSTALLATION SECTION =====
    - name: Install and Configure Datadog Agent
      block:
        - name: Download Datadog installation script
          get_url:
            url: https://s3.amazonaws.com/dd-agent/scripts/install_script_agent7.sh
            dest: /tmp/datadog_install.sh
            mode: '0755'
        
        - name: Install Datadog Agent
          shell: |
            DD_API_KEY="{{ datadog_api_key }}" \
            DD_SITE="datadoghq.eu" \
            DD_HOSTNAME="{{ cloud_provider | lower }}-cloudguard-instance" \
            bash /tmp/datadog_install.sh
          args:
            creates: /etc/datadog-agent/datadog.yaml
        
        - name: Configure Datadog Agent main config
          copy:
            content: |
              api_key: {{ datadog_api_key }}
              site: datadoghq.eu
              hostname: {{ cloud_provider | lower }}-cloudguard-instance
              
              tags:
                - env:production
                - project:cloudguard-orchestration
                - cloud:{{ cloud_provider | lower }}
                - region:{{ ansible_hostname }}
                - service:multi-cloud-orchestration
              
              logs_enabled: true
            dest: /etc/datadog-agent/datadog.yaml
            owner: dd-agent
            group: dd-agent
            mode: '0640'
            force: yes
        
        - name: Configure nginx monitoring
          copy:
            content: |
              init_config:
              
              instances:
                - nginx_status_url: http://localhost/nginx_status
            dest: /etc/datadog-agent/conf.d/nginx.d/conf.yaml
            owner: dd-agent
            group: dd-agent
            mode: '0644'
            force: yes
        
        - name: Restart Datadog Agent
          systemd:
            name: datadog-agent
            state: restarted
            enabled: yes
            daemon_reload: yes
        
        - name: Wait for agent to start
          pause:
            seconds: 10
        
        - name: Check Datadog Agent status
          command: datadog-agent status
          register: agent_status
          ignore_errors: yes
        
        - name: Display agent status
          debug:
            msg: "Datadog Agent installed and running on {{ cloud_provider }}"
      when: datadog_api_key is defined
    
    # ===== DEPLOYMENT INFO SECTION =====
    - name: Create deployment info file
      copy:
        content: |
          ===================================
          CloudGuard Multi-Cloud Orchestration Platform
          ===================================
          Cloud Provider: {{ cloud_provider }}
          Instance: {{ ansible_hostname }}
          IP Address: {{ ansible_default_ipv4.address }}
          Region: {{ ansible_hostname }}
          OS Family: {{ ansible_os_family }}
          
          Endpoints:
          - Web Interface: http://{{ ansible_default_ipv4.address }}/
          - Health Check: http://{{ ansible_default_ipv4.address }}/health
          
          Monitoring:
          - Datadog Agent: {{ 'Installed' if datadog_api_key is defined else 'Not Installed' }}
          - Region: EU (datadoghq.eu)
          ===================================
        dest: /home/{{ ansible_user }}/deployment-info.txt
        mode: '0644'
        force: yes
    
    - name: Display deployment information
      debug:
        msg:
          - "âœ… Infrastructure Deployed Successfully!"
          - "Provider: {{ cloud_provider }}"
          - "URL: http://{{ ansible_default_ipv4.address }}/"
          - "Health: http://{{ ansible_default_ipv4.address }}/health"
          - "Datadog Agent: {{ 'Installed and collecting metrics' if datadog_api_key is defined else 'Not installed' }}"
  
  handlers:
    - name: restart nginx
      systemd:
        name: nginx
        state: restarted